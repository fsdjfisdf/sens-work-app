<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>S-WORKS | 역량 레벨 뷰어</title>

  <link rel="stylesheet" href="./css/skill_levels.css"/>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.9/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Excel(xlsx) 내보내기 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- NAV -->
  <nav>
    <div class="inner">
      <div class="nav-container">
        <h1 class="nav-title"><a href="./index.html">S-WORKS</a></h1>
        <div class="sign-container unsigned">
          <a href="./signin.html" class="sign-link">Login</a>
        </div>
        <div class="sign-container signed hidden">
          <button class="menu-btn" aria-label="메뉴 열기">
            <div class="menu-icon"><span></span><span></span><span></span></div>
          </button>
        </div>
      </div>
    </div>
    <div class="menu-bar">
      <div class="menu-bar-content">
        <a href="./user_info.html" class="menu-item">SECM</a>
        <a href="./worklog.html" class="menu-item">Create Worklog</a>
        <a href="./approval.html" class="menu-item">Worklog Approval</a>
        <a href="./loadworklog.html" class="menu-item">Load Worklog</a>
        <a href="./equipment_signal.html" class="menu-item">Equipment</a>
        <a href="./Setupeq.html" class="menu-item">Setup EQ</a>
        <a href="./PCI.html" class="menu-item">PCI</a>
        <a href="./CHECKLIST.html" class="menu-item">Checklist</a>
        <a href="./business.html" class="menu-item">Business trip</a>
        <a href="./report.html" class="menu-item">국내 출장 보고서</a>
        <a href="./workload.html" class="menu-item admin-only">Operating Rate</a>
        <a href="./analysis.html" class="menu-item admin-only">Predicted Workers</a>
        <a href="./update.html" class="menu-item">Update</a>
        <a href="./skill_levels.html" class="menu-item active">역량 레벨</a>
        <button id="sign-out" class="menu-item">Logout</button>
      </div>
    </div>
  </nav>

  <main class="inner">
    <header class="page-head">
      <h2>역량 레벨 (MAIN / MULTI)</h2>
      <button id="btn-guide" class="btn ghost" aria-haspopup="dialog" aria-controls="guide-modal">설명 ?</button>
    </header>

    <!-- Filters -->
    <section class="filters" aria-label="검색 필터">
      <div class="row">
        <label class="field">
          <span>이름</span>
          <input id="f-name" type="text" placeholder="이름 검색(부분 일치)" />
        </label>
        <label class="field">
          <span>Group</span>
          <select id="f-group">
            <option value="">전체</option>
          </select>
        </label>
        <label class="field">
          <span>Site</span>
          <select id="f-site">
            <option value="">전체</option>
          </select>
        </label>
        <label class="field">
          <span>EQ</span>
          <select id="f-eq">
            <option value="">전체</option>
            <option>SUPRA N</option>
            <option>SUPRA XP</option>
            <option>INTEGER</option>
            <option>PRECIA</option>
            <option>ECOLITE</option>
            <option>GENEVA</option>
            <option>HDW</option>
          </select>
        </label>
        <label class="field">
          <span>LEVEL(report)</span>
          <select id="f-report">
            <option value="">전체</option>
            <option>0</option>
            <option>1</option>
            <option>2</option>
            <option>2-2</option>
          </select>
        </label>
      </div>
      <div class="row">
    <div class="actions">
        <button id="btn-search" class="btn primary">검색</button>
        <button id="btn-reset" class="btn">초기화</button>
        <button id="btn-export" class="btn ghost">엑셀 저장</button>
    </div>
    </div>
      </div>
    </section>

    <!-- Table -->
    <section class="list">
      <div class="table-wrap">
        <table id="tbl" aria-label="역량 레벨 표">
          <thead>
            <tr>
              <th style="min-width:120px;">Name</th>
              <th>Group</th>
              <th>Site</th>
              <th>필기 LEVEL</th>
              <th>MAIN EQ</th>
              <th>MAIN Avg</th>
              <th>MAIN Level</th>
              <th>MULTI EQ</th>
              <th>MULTI SET UP</th>
              <th>MULTI Level</th>
              <th>승급</th>
              <th>상세</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="empty" class="empty hidden">검색 결과가 없습니다.</div>
      <div id="loading" class="loading hidden" role="status" aria-live="polite">로딩 중…</div>
      <div id="error" class="error hidden">데이터를 불러오는 중 오류가 발생했습니다.</div>
    </section>
  </main>

  <!-- Detail Modal -->
  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="modal-content">
      <button class="close" id="detail-close" aria-label="닫기">×</button>
      <h3 id="detail-title">상세</h3>

      <div class="detail-grid">
        <div class="info">
          <dl>
            <div><dt>Name</dt><dd id="d-name">-</dd></div>
            <div><dt>Group</dt><dd id="d-group">-</dd></div>
            <div><dt>Site</dt><dd id="d-site">-</dd></div>
            <div><dt>LEVEL(report)</dt><dd id="d-report">-</dd></div>
            <div><dt>MAIN EQ</dt><dd id="d-main-eq">-</dd></div>
            <div><dt>MULTI EQ</dt><dd id="d-multi-eq">-</dd></div>
          </dl>
          <div class="tags">
            <span id="d-main-lvl" class="tag">MAIN:-</span>
            <span id="d-multi-lvl" class="tag">MULTI:-</span>
          </div>
          <div class="tags">
            <span id="d-db-main" class="tag subtle"></span>
            <span id="d-db-multi" class="tag subtle"></span>
            <span id="d-promo" class="tag promote"></span>
          </div>
        </div>

        <div class="charts">
          <div class="chart-card">
            <h4>MAIN — 평균 vs 기준 역량</h4>
            <canvas id="chart-main"></canvas>
          </div>
          <div class="chart-card">
            <h4>MULTI — SET UP vs 기준 역량(2-2)</h4>
            <canvas id="chart-multi"></canvas>
          </div>
        </div>

        <div class="analysis-grid">
          <div class="analysis-card">
              <h4>MAIN — 합격 기준 & 부족도</h4>
              <div id="crit-main" class="criteria"></div>
              <div class="progress-wrap">
                <div id="prog-main" class="progress-bar"><span id="prog-main-text"></span></div>
              </div>
              <div id="gap-main" class="gap"></div>
              <div id="weak-main" class="weak"></div>
          </div>

          <div class="analysis-card">
              <h4>MULTI — 합격 기준 & 부족도</h4>
              <div id="crit-multi" class="criteria"></div>
              <div class="progress-wrap">
                <div id="prog-multi" class="progress-bar"><span id="prog-multi-text"></span></div>
              </div>
              <div id="gap-multi" class="gap"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Guide Modal -->
  <div id="guide-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="guide-title">
    <div class="modal-content wide">
      <button class="close" id="guide-close" aria-label="닫기">×</button>
      <h3 id="guide-title">레벨 산정 방법 (상세 설명)</h3>

<div class="guide-body">
  <h4>📌 30초 핵심 요약</h4>
  <ul>
    <li><b>LEVEL(report)</b>는 필기 합격 레벨(0, 1, 2, 2-2)입니다.</li>
    <li><b>MAIN EQ</b>는 <u>SET UP</u>과 <u>MAINT</u>의 <b>평균</b>으로 레벨을 산정합니다. (표시: 1-1 / 1-2 / 1-3 / 2)</li>
    <li><b>MULTI EQ</b>는 <b>SET UP 단독</b>으로 <b>Lv.2-2</b> 달성 여부만 봅니다. (표시: 2-2 또는 0)</li>
    <li>화면의 “승급”은 <b>현재 산정 결과</b>가 <b>DB에 저장된 값</b>보다 높을 때만 표기됩니다.</li>
  </ul>

  <h4>🧭 어떻게 산정하나요? (흐름)</h4>
  <ol>
    <li><b>LEVEL(report)=0</b> → 레벨 산정하지 않음(모두 0 취급)</li>
    <li><b>LEVEL(report)=1</b> → MAIN 평균을 설비별 기준과 비교해 <b>1-1 / 1-2 / 1-3</b> 중 하나로 산정
      <div class="muted">* MULTI는 이 구간에서 산정하지 않음</div>
    </li>
    <li><b>LEVEL(report)=2</b> → MAIN 평균이 Lv.2 기준을 넘으면 <b>2</b>, 못 넘으면 <b>1-3/1-2/1-1</b>로 산정
      <div class="muted">* MULTI는 이 구간에서 산정하지 않음</div>
    </li>
    <li><b>LEVEL(report)=2-2</b>
      <ul>
        <li><u>MAIN</u>은 위와 똑같이 <b>Lv.2 트랙(최대 2)</b>으로 산정합니다. <span class="muted">2-2는 MAIN의 상위단계가 아니라 MULTI 전용 트랙이에요.</span></li>
        <li><u>MULTI</u>는 해당 설비의 <b>SET UP</b>만으로 <b>Lv.2-2 기준</b> 충족 여부를 봅니다. (충족 시 <b>2-2</b>, 미충족 시 <b>0</b>)</li>
      </ul>
    </li>
  </ol>

  <h4>📊 설비별 기준 역량(%)</h4>
  <div class="table-wrap small">
    <table class="mini">
      <thead>
        <tr><th>EQ</th><th>Lv.1-1</th><th>Lv.1-2</th><th>Lv.1-3</th><th>Lv.2</th><th>Lv.2-2(SET UP)</th></tr>
      </thead>
      <tbody>
        <tr><td>SUPRA N</td><td>10</td><td>25</td><td>46</td><td>61</td><td>70</td></tr>
        <tr><td>SUPRA XP</td><td>10</td><td>25</td><td>46</td><td>61</td><td>70</td></tr>
        <tr><td>INTEGER</td><td>12</td><td>31</td><td>52</td><td>63</td><td>70</td></tr>
        <tr><td>PRECIA</td><td>12</td><td>31</td><td>52</td><td>63</td><td>70</td></tr>
        <tr><td>ECOLITE</td><td>6</td><td>23</td><td>43</td><td>59</td><td>70</td></tr>
        <tr><td>GENEVA</td><td>6</td><td>23</td><td>43</td><td>59</td><td>70</td></tr>
        <tr><td>HDW</td><td>6</td><td>23</td><td>43</td><td>59</td><td>70</td></tr>
      </tbody>
    </table>
  </div>

  <h4>🧪 예시로 이해하기</h4>
  <ol>
    <li><b>예시 A — report=1, MAIN만 평가</b><br>
      <span class="muted">조건:</span> MAIN EQ = SUPRA N, SET UP 35%, MAINT 27% → 평균 <b>31%</b><br>
      <span class="muted">비교:</span> SUPRA N 기준(1-1:10 / 1-2:25 / 1-3:46)<br>
      <span class="muted">결과:</span> 평균 31%는 <b>1-2</b> 이상, <b>1-3</b> 미달 → <b>MAIN Level=1-2</b><br>
      <span class="muted">메모:</span> MULTI는 report=1이라 평가하지 않음
    </li>
    <li><b>예시 B — report=2, MAIN이 2 가능</b><br>
      <span class="muted">조건:</span> MAIN EQ = PRECIA, 평균 <b>64%</b><br>
      <span class="muted">비교:</span> PRECIA Lv.2 기준 63%<br>
      <span class="muted">결과:</span> 평균이 Lv.2 기준을 넘으므로 <b>MAIN Level=2</b> (최대치)
    </li>
    <li><b>예시 C — report=2-2, MAIN은 2 트랙 / MULTI는 2-2 판정</b><br>
      <span class="muted">조건:</span> MAIN EQ = SUPRA XP (평균 62%), MULTI EQ = SUPRA XP (SET UP 71%)<br>
      <span class="muted">MAIN:</span> Lv.2 기준 61% → 평균 62% ≥ 61% ⇒ <b>MAIN Level=2</b><br>
      <span class="muted">MULTI:</span> 2-2 기준 70% → SET UP 71% ≥ 70% ⇒ <b>MULTI Level=2-2</b>
    </li>
    <li><b>예시 D — 승급 추천 표시</b><br>
      <span class="muted">조건:</span> DB 저장값 LEVEL=0(=표시 0), 현재 산정 <b>MAIN=1-2</b><br>
      <span class="muted">결과:</span> 산정이 더 높으므로 <b>승급: MAIN 0 → 1-2</b> 로 표시<br>
      <span class="muted">또는:</span> DB MULTI LEVEL=0, 현재 산정 <b>MULTI=2-2</b> → <b>승급: MULTI 0 → 2-2</b>
    </li>
  </ol>

  <h4>💾 DB 컬럼과 화면 표기의 대응</h4>
  <ul>
    <li><b>MAIN 저장</b>: <code>LEVEL(int)</code> = <code>1=1-1, 2=1-2, 3=1-3, 4=2</code> <span class="muted">(화면은 1-1/1-2/1-3/2로 표기)</span></li>
    <li><b>MULTI 저장</b>: <code>MULTI LEVEL(int)</code> = <code>0=미취득, 1=2-2 취득</code></li>
    <li><b>LEVEL(report)</b>: 필기 합격 값(0, 1, 2, 2-2) — <span class="muted">산정 “가능 범위”를 정합니다.</span></li>
  </ul>

  <h4>❓자주 묻는 질문</h4>
  <ul class="muted">
    <li><b>Q. report가 2-2면 MAIN도 2-2인가요?</b><br>A. 아니요. <b>MAIN은 최대 2</b>까지입니다. 2-2는 <b>MULTI 전용</b> 판정입니다.</li>
    <li><b>Q. MULTI는 언제 계산되나요?</b><br>A. <b>report=2-2</b>일 때만, 해당 설비의 <b>SET UP</b>으로 <b>2-2</b> 충족 여부를 봅니다.</li>
    <li><b>Q. 평균은 어떻게 계산하나요?</b><br>A. MAIN은 <b>(SET UP + MAINT) ÷ 2</b> 입니다.</li>
    <li><b>Q. 기준 퍼센트 값은 어디서 오나요?</b><br>A. 설비별 <b>기준 역량 표</b> 값을 사용합니다(위 표 참고).</li>
  </ul>
</div>

      </div>
    </div>
  </div>

  <!-- scripts -->
  <script src="./js/logoutTimer.js" defer></script>
  <script src="./js/skill_levels.js"></script>
  <script>
    // 공통 헤더/메뉴/로그인 토글
    document.addEventListener("DOMContentLoaded", function() {
      const token = localStorage.getItem("x-access-token");
      const userRole = localStorage.getItem("user-role");

      if (!token) {
        document.querySelector(".unsigned")?.classList.remove("hidden");
        document.querySelector(".signed")?.classList.add("hidden");
        alert('로그인이 필요합니다.');
        window.location.replace('./signin.html');
        return;
      } else {
        document.querySelector(".unsigned")?.classList.add("hidden");
        document.querySelector(".signed")?.classList.remove("hidden");
      }
      if (!token || userRole !== 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
      }

const menuBtn = document.querySelector('.menu-btn');
const menuBar = document.querySelector('.menu-bar');
menuBtn?.addEventListener('click', () => {
  menuBar.classList.toggle('open');
  menuBtn.classList.toggle('active');   // ← 추가: 아이콘을 X로
});
document.addEventListener('click', (e) => {
  if (!menuBtn?.contains(e.target) && !menuBar.contains(e.target)) {
    menuBar.classList.remove('open');
    menuBtn.classList.remove('active'); // ← 추가: 바깥 클릭 시 원복
  }
});


      document.getElementById('sign-out')?.addEventListener('click', function() {
        localStorage.removeItem("x-access-token");
        localStorage.removeItem("user-role");
        alert("로그아웃 되었습니다.");
        window.location.replace("./signin.html");
      });
    });
  </script>
</body>
</html>
