<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>S-WORKS | 역량 레벨 뷰어</title>

  <link rel="stylesheet" href="./css/skill_levels.css"/>

  <!-- libs -->
  <script src="https://cdn.jsdelivr.net/npm/axios@1.7.9/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels"></script>
  <!-- Excel(xlsx) 내보내기 -->
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
</head>
<body>
  <!-- NAV -->
  <nav>
    <div class="inner">
      <div class="nav-container">
        <h1 class="nav-title"><a href="./index.html">S-WORKS</a></h1>
        <div class="sign-container unsigned">
          <a href="./signin.html" class="sign-link">Login</a>
        </div>
        <div class="sign-container signed hidden">
          <button class="menu-btn" aria-label="메뉴 열기">
            <div class="menu-icon"><span></span><span></span><span></span></div>
          </button>
        </div>
      </div>
    </div>
    <div class="menu-bar">
      <div class="menu-bar-content">
        <a href="./user_info.html" class="menu-item">SECM</a>
        <a href="./worklog.html" class="menu-item">Create Worklog</a>
        <a href="./approval.html" class="menu-item">Worklog Approval</a>
        <a href="./loadworklog.html" class="menu-item">Load Worklog</a>
        <a href="./equipment_signal.html" class="menu-item">Equipment</a>
        <a href="./Setupeq.html" class="menu-item">Setup EQ</a>
        <a href="./PCI.html" class="menu-item">PCI</a>
        <a href="./CHECKLIST.html" class="menu-item">Checklist</a>
        <a href="./business.html" class="menu-item">Business trip</a>
        <a href="./report.html" class="menu-item">국내 출장 보고서</a>
        <a href="./workload.html" class="menu-item admin-only">Operating Rate</a>
        <a href="./analysis.html" class="menu-item admin-only">Predicted Workers</a>
        <a href="./update.html" class="menu-item">Update</a>
        <a href="./skill_levels.html" class="menu-item active">역량 레벨</a>
        <button id="sign-out" class="menu-item">Logout</button>
      </div>
    </div>
  </nav>

  <main class="inner">
    <header class="page-head">
      <h2>역량 레벨 (MAIN / MULTI)</h2>
      <button id="btn-guide" class="btn ghost" aria-haspopup="dialog" aria-controls="guide-modal">설명 ?</button>
    </header>

    <!-- Filters -->
    <section class="filters" aria-label="검색 필터">
      <div class="row">
        <label class="field">
          <span>이름</span>
          <input id="f-name" type="text" placeholder="이름 검색(부분 일치)" />
        </label>
        <label class="field">
          <span>Group</span>
          <select id="f-group">
            <option value="">전체</option>
          </select>
        </label>
        <label class="field">
          <span>Site</span>
          <select id="f-site">
            <option value="">전체</option>
          </select>
        </label>
        <label class="field">
          <span>EQ</span>
          <select id="f-eq">
            <option value="">전체</option>
            <option>SUPRA N</option>
            <option>SUPRA XP</option>
            <option>INTEGER</option>
            <option>PRECIA</option>
            <option>ECOLITE</option>
            <option>GENEVA</option>
            <option>HDW</option>
          </select>
        </label>
        <label class="field">
          <span>LEVEL(report)</span>
          <select id="f-report">
            <option value="">전체</option>
            <option>0</option>
            <option>1</option>
            <option>2</option>
            <option>2-2</option>
          </select>
        </label>
      </div>
      <div class="row">
        <label class="check">
          <input type="checkbox" id="f-promo-only" />
          <span>승급 추천만</span>
        </label>
        <div class="row">
        <div class="actions">
            <button id="btn-search" class="btn primary">검색</button>
            <button id="btn-reset" class="btn">초기화</button>
            <button id="btn-export" class="btn ghost">엑셀 저장</button>
        </div>
        </div>
      </div>
    </section>

    <!-- Table -->
    <section class="list">
      <div class="table-wrap">
        <table id="tbl" aria-label="역량 레벨 표">
          <thead>
            <tr>
              <th style="min-width:120px;">Name</th>
              <th>Group</th>
              <th>Site</th>
              <th>필기 LEVEL</th>
              <th>MAIN EQ</th>
              <th>MAIN Avg</th>
              <th>MAIN Level</th>
              <th>MULTI EQ</th>
              <th>MULTI SET UP</th>
              <th>MULTI Level</th>
              <th>승급</th>
              <th>상세</th>
            </tr>
          </thead>
          <tbody id="tbody"></tbody>
        </table>
      </div>

      <div id="empty" class="empty hidden">검색 결과가 없습니다.</div>
      <div id="loading" class="loading hidden" role="status" aria-live="polite">로딩 중…</div>
      <div id="error" class="error hidden">데이터를 불러오는 중 오류가 발생했습니다.</div>
    </section>
  </main>

  <!-- Detail Modal -->
  <div id="detail-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="detail-title">
    <div class="modal-content">
      <button class="close" id="detail-close" aria-label="닫기">×</button>
      <h3 id="detail-title">상세</h3>

      <div class="detail-grid">
        <div class="info">
          <dl>
            <div><dt>Name</dt><dd id="d-name">-</dd></div>
            <div><dt>Group</dt><dd id="d-group">-</dd></div>
            <div><dt>Site</dt><dd id="d-site">-</dd></div>
            <div><dt>LEVEL(report)</dt><dd id="d-report">-</dd></div>
            <div><dt>MAIN EQ</dt><dd id="d-main-eq">-</dd></div>
            <div><dt>MULTI EQ</dt><dd id="d-multi-eq">-</dd></div>
          </dl>
          <div class="tags">
            <span id="d-main-lvl" class="tag">MAIN:-</span>
            <span id="d-multi-lvl" class="tag">MULTI:-</span>
          </div>
          <div class="tags">
            <span id="d-db-main" class="tag subtle"></span>
            <span id="d-db-multi" class="tag subtle"></span>
            <span id="d-promo" class="tag promote"></span>
          </div>
        </div>

        <div class="charts">
          <div class="chart-card">
            <h4>MAIN — 평균 vs 기준 역량</h4>
            <canvas id="chart-main"></canvas>
          </div>
          <div class="chart-card">
            <h4>MULTI — SET UP vs 기준 역량(2-2)</h4>
            <canvas id="chart-multi"></canvas>
          </div>
        </div>

        <div class="analysis-grid">
          <div class="analysis-card">
              <h4>MAIN — 합격 기준 & 부족도</h4>
              <div id="crit-main" class="criteria"></div>
              <div class="progress-wrap">
                <div id="prog-main" class="progress-bar"><span id="prog-main-text"></span></div>
              </div>
              <div id="gap-main" class="gap"></div>
              <div id="weak-main" class="weak"></div>
          </div>

          <div class="analysis-card">
              <h4>MULTI — 합격 기준 & 부족도</h4>
              <div id="crit-multi" class="criteria"></div>
              <div class="progress-wrap">
                <div id="prog-multi" class="progress-bar"><span id="prog-multi-text"></span></div>
              </div>
              <div id="gap-multi" class="gap"></div>
          </div>
        </div>

      </div>
    </div>
  </div>

  <!-- Guide Modal -->
  <div id="guide-modal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="guide-title">
    <div class="modal-content wide">
      <button class="close" id="guide-close" aria-label="닫기">×</button>
      <h3 id="guide-title">레벨 산정 방법 (상세 설명)</h3>

      <div class="guide-body">
        <h4>1) 용어</h4>
        <ul>
          <li><b>LEVEL(report)</b>: 필기시험 합격 레벨 (0, 1, 2, 2-2)</li>
          <li><b>MAIN EQ</b>: 주력 설비 — <u>SET UP</u>과 <u>MAINT</u>의 <b>평균</b>으로 평가</li>
          <li><b>MULTI EQ</b>: 보조 설비 — <b>SET UP 단독</b>으로 평가 (2-2 트랙)</li>
          <li><b>기준 역량</b>: 설비별 레벨 판정 기준 퍼센트(아래 표)</li>
          <li><b>DB 저장 규칙</b>:
            <ul>
              <li>MAIN: <code>LEVEL(int)</code> → 1=1-1, 2=1-2, 3=1-3, 4=2 (UI는 1-1/1-2/1-3/2로 표기)</li>
              <li>MULTI: <code>MULTI LEVEL(int)</code> → 0=미취득, 1=2-2 취득</li>
            </ul>
          </li>
        </ul>

        <h4>2) 평가 규칙</h4>
        <ol>
          <li><b>LEVEL(report)=0</b>: MAIN/MULTI 레벨 산정하지 않음(0으로 간주)</li>
          <li><b>LEVEL(report)=1</b>:
            <ul>
              <li>MAIN 평균값으로 <code>1-1 / 1-2 / 1-3</code> 산정</li>
              <li>MULTI: 산정하지 않음</li>
            </ul>
          </li>
          <li><b>LEVEL(report)=2</b>:
            <ul>
              <li>MAIN 평균값이 Lv.2 기준 역량 도달 시 <b>2</b> (미달 시 1-3/1-2/1-1)</li>
              <li>MULTI: 산정하지 않음</li>
            </ul>
          </li>
          <li><b>LEVEL(report)=2-2</b>:
            <ul>
              <li><u>MAIN</u>: 여전히 <b>Lv.2 트랙</b>(최대 2)으로 산정 — <b>2-2는 2 이후 상위 레벨</b>이므로 MAIN은 최소 2까지 표기</li>
              <li><u>MULTI</u>: 해당 설비의 <b>SET UP</b>만으로 <b>Lv.2-2</b> 충족 여부 판정(충족 시 DB의 MULTI LEVEL=1)</li>
            </ul>
          </li>
        </ol>

        <h4>3) 설비별 기준 역량(%)</h4>
        <div class="table-wrap small">
          <table class="mini">
            <thead>
              <tr><th>EQ</th><th>Lv.1-1</th><th>Lv.1-2</th><th>Lv.1-3</th><th>Lv.2</th><th>Lv.2-2(SET UP)</th></tr>
            </thead>
            <tbody>
              <tr><td>SUPRA N</td><td>10</td><td>25</td><td>46</td><td>61</td><td>70</td></tr>
              <tr><td>SUPRA XP</td><td>10</td><td>25</td><td>46</td><td>61</td><td>70</td></tr>
              <tr><td>INTEGER</td><td>12</td><td>31</td><td>52</td><td>63</td><td>70</td></tr>
              <tr><td>PRECIA</td><td>12</td><td>31</td><td>52</td><td>63</td><td>70</td></tr>
              <tr><td>ECOLITE</td><td>6</td><td>23</td><td>43</td><td>59</td><td>70</td></tr>
              <tr><td>GENEVA</td><td>6</td><td>23</td><td>43</td><td>59</td><td>70</td></tr>
              <tr><td>HDW</td><td>6</td><td>23</td><td>43</td><td>59</td><td>70</td></tr>
            </tbody>
          </table>
        </div>

        <h4>4) 승급 추천 로직</h4>
        <ul class="muted">
          <li>MAIN: 실제 산정 레벨(1-1/1-2/1-3/2)을 DB(LEVEL=1~4)와 비교해 <b>산정 &gt; DB</b>이면 승급 추천</li>
          <li>MULTI(2-2): 산정=2-2인데 DB(<code>MULTI LEVEL</code>)가 0이면 승급 추천</li>
        </ul>
      </div>
    </div>
  </div>

  <!-- scripts -->
  <script src="./js/logoutTimer.js" defer></script>
  <script src="./js/skill_levels.js"></script>
  <script>
    // 공통 헤더/메뉴/로그인 토글
    document.addEventListener("DOMContentLoaded", function() {
      const token = localStorage.getItem("x-access-token");
      const userRole = localStorage.getItem("user-role");

      if (!token) {
        document.querySelector(".unsigned")?.classList.remove("hidden");
        document.querySelector(".signed")?.classList.add("hidden");
        alert('로그인이 필요합니다.');
        window.location.replace('./signin.html');
        return;
      } else {
        document.querySelector(".unsigned")?.classList.add("hidden");
        document.querySelector(".signed")?.classList.remove("hidden");
      }
      if (!token || userRole !== 'admin') {
        document.querySelectorAll('.admin-only').forEach(el => el.style.display = 'none');
      }

const menuBtn = document.querySelector('.menu-btn');
const menuBar = document.querySelector('.menu-bar');
menuBtn?.addEventListener('click', () => {
  menuBar.classList.toggle('open');
  menuBtn.classList.toggle('active');   // ← 추가: 아이콘을 X로
});
document.addEventListener('click', (e) => {
  if (!menuBtn?.contains(e.target) && !menuBar.contains(e.target)) {
    menuBar.classList.remove('open');
    menuBtn.classList.remove('active'); // ← 추가: 바깥 클릭 시 원복
  }
});


      document.getElementById('sign-out')?.addEventListener('click', function() {
        localStorage.removeItem("x-access-token");
        localStorage.removeItem("user-role");
        alert("로그아웃 되었습니다.");
        window.location.replace("./signin.html");
      });
    });
  </script>
</body>
</html>
