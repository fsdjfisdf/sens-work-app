<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Predicted Workers</title>
  <link rel="stylesheet" href="./css/analysis.css" />
  <link rel="stylesheet" href="./css/workload.css" />
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <nav>
    <div class="inner">
      <div class="nav-container">
        <h1 class="nav-title"><a href="./index.html">S-WORKS</a></h1>
        <div class="sign-container unsigned">
          <a href="./signin.html" class="sign-link">Login</a>
        </div>
        <div class="sign-container signed hidden">
          <button class="menu-btn">
            <div class="menu-icon">
              <span></span><span></span><span></span>
            </div>
          </button>
        </div>
      </div>
    </div>
    <div class="menu-bar">
            <div class="menu-bar-content">
                <a href="./user_info.html" class="menu-item">SECM</a>
                <a href="./worklog.html" class="menu-item">Create Worklog</a>
                <a href="./approval.html" class="menu-item">Worklog Approval</a>
                <a href="./loadworklog.html" class="menu-item">Load Worklog</a>
                <a href="./equipment_signal.html" class="menu-item">Equipment</a>
                <a href="./Setupeq.html" class="menu-item">Setup EQ</a>
                <a href="./PCI.html" class="menu-item">PCI</a>
                <a href="./CHECKLIST.html" class="menu-item">Checklist</a>
                <a href="./business.html" class="menu-item">Business trip</a>
                <a href="./report.html" class="menu-item">국내 출장 보고서</a>
                <a href="./workload.html" class="menu-item admin-only">Operating Rate</a>
                <a href="./analysis.html" class="menu-item admin-only">Predicted Workers</a>
                <a href="./update.html" class="menu-item">Update</a>
                <button id="sign-out" class="menu-item">Logout</button>
            </div>
    </div>
  </nav>

  <div class="container">
    <header class="header">
      <h1 class="title">Predicted Workers</h1>
      <span class="pill">Eng'r 수 예측</span>
      <div class="right-info">업데이트: <span id="lastUpdated">-</span></div>
    </header>

    <!-- ① 설정 -->
    <details class="section" open>
      <summary>① 설정 <span class="summary-badge">필터</span></summary>
      <div class="section-body">

        <!-- 1) 기본 필터 -->
        <div class="card-block">
          <h3 class="block-title">기본</h3>
          <div class="grid12">
            <div class="span-3">
              <label for="freq">집계 단위</label>
              <select id="freq" class="card">
                <option value="month" selected>월</option>
                <option value="week">주</option>
                <option value="day">일</option>
              </select>
            </div>

            <div class="span-3">
              <label for="horizonCount">예측 기간(숫자)</label>
              <div class="inline card">
                <input id="horizonCount" type="number" min="1" step="1" value="12" style="width:90px" />
                <span id="horizonUnit" class="badge">개월</span>
              </div>
              <small class="dim">N개월/주/일 뒤까지</small>
            </div>

            <div class="span-3">
              <label for="groupSelect">그룹</label>
              <select id="groupSelect" class="card">
                <option value="">전체</option>
                <option>PEE1</option>
                <option>PEE2</option>
                <option>PSKH</option>
              </select>
            </div>
            <div class="span-3">
              <label for="siteSelect">사이트</label>
              <select id="siteSelect" class="card">
                <option value="">전체</option>
                <option>PT</option>
                <option>HS</option>
                <option>IC</option>
                <option>CJ</option>
                <option>PSKH</option>
              </select>
            </div>
          </div>
        </div>

        <!-- 2) 산식 옵션 -->
        <div class="card-block">
          <h3 class="block-title">계산 옵션</h3>
          <div class="grid12">
            <div class="span-3">
              <label for="hoursPerDay">기준 근로시간(1인·h)</label>
              <input id="hoursPerDay" class="card" type="number" step="0.5" min="1" value="3.5" />
            </div>
            <div class="span-3">
              <label for="daysPerBucket">근무가능일수(d)</label>
              <input id="daysPerBucket" class="card" type="number" step="1" min="1" value="21" />
              <small id="daysHint" class="dim">월 기준 예: 21</small>
            </div>
            <div class="span-3">
              <label for="rounding">인원 올림 여부</label>
              <select id="rounding" class="card">
                <option value="ceil" selected>올림</option>
                <option value="round">반올림</option>
                <option value="floor">내림</option>
              </select>
            </div>
            <div class="span-3">
              <label>표시 옵션</label>
              <div class="chip inline card"><label><input type="checkbox" id="showConf" /> 신뢰구간</label></div>
              <div class="chip inline card" style="margin-top:6px"><label><input type="checkbox" id="includeMove" checked /> 이동시간 포함</label></div>
              <div class="chip inline card" style="margin-top:6px">
                <label><input type="checkbox" id="normalizeByBizDays" checked /> 근무일수 기준 작업시간 정규화</label>
              </div>
              <small class="dim">예측 h × (해당 달 평일수 / 기준근무일수)</small>
            </div>
          </div>

          <div class="grid12">
            <div class="span-4">
              <label for="planMode">계획 모드 (바쁠 때 상향)</label>
              <select id="planMode" class="card">
                <option value="baseline">평균 (ŷ)</option>
                <option value="upper">상한 95% (ŷᵤ)</option>
                <option value="blend" selected>상한 가중(α·ŷᵤ + (1-α)·ŷ)</option>
              </select>
            </div>
            <div class="span-4" id="alphaWrap">
              <label for="alpha">상한 가중치 α <span class="badge" id="alphaVal">0.50</span></label>
              <input type="range" id="alpha" class="card" min="0" max="1" step="0.05" value="0.5" />
            </div>
            <div class="span-4">
              <label for="addBuffer">추가 버퍼(%)</label>
              <input id="addBuffer" class="card" type="number" step="1" value="5" />
              <small class="dim">추가 버퍼 설정(5~15%)</small>
            </div>
          </div>

          <div class="grid12">
            <div class="span-4">
              <label for="absencePct">결원(휴가/교육) 비율(%)</label>
              <input id="absencePct" class="card" type="number" step="1" min="0" max="50" value="10" />
              <small class="dim">인원 산출 시 / (1 - 비율) 보정</small>
            </div>
            <div class="span-8"></div>
          </div>
        </div>

        <!-- 3) 보수화 옵션 -->
        <div class="card-block">
          <h3 class="block-title">보수화 옵션</h3>
          <div class="grid12">
            <div class="span-4">
              <label class="inline"><input type="checkbox" id="useLower" /> ŷ 대신 하한(ŷₗ) 사용</label>
              <small class="dim">체크 시 하한 100% 사용</small>
            </div>
            <div class="span-4">
              <label for="lowerAlpha">하한 가중치 β <span class="badge" id="lowerAlphaVal">0.00</span></label>
              <input type="range" id="lowerAlpha" min="0" max="1" step="0.05" value="0" />
              <small class="dim">0=사용 안 함, 1=하한 100%</small>
            </div>
            <div class="span-4">
              <label for="smoothWin">스무딩 윈도 W (버킷)</label>
              <input id="smoothWin" class="card" type="number" min="1" step="1" value="1" />
              <small class="dim">1=스무딩 없음</small>
            </div>
          </div>
          <div class="grid12">
            <div class="span-4">
              <label for="growthCapPct">증가 캡(%)</label>
              <input id="growthCapPct" class="card" type="number" min="0" step="1" value="0" />
              <small class="dim">예: 8 → 버킷당 +8% 이내</small>
            </div>
            <div class="span-4">
              <label for="growthCapAbs">증가 캡(명)</label>
              <input id="growthCapAbs" class="card" type="number" min="0" step="1" value="0" />
              <small class="dim">예: 2 → 버킷당 +2명 이내</small>
            </div>
            <div class="span-4"></div>
          </div>
        </div>

        <!-- 4) 액션 -->
        <div class="toolbar">
          <button id="btnRun" class="btn primary" type="button">예측 실행</button>
          <button id="btnReset" class="btn ghost" type="button">초기화</button>
          <button id="btnCsv" class="btn ghost" type="button">CSV 내보내기</button>
        </div>
      </div>
    </details>

    <!-- ② KPI -->
    <details class="section" open>
      <summary>② KPI <span class="summary-badge">요약 지표</span></summary>
      <div class="section-body">
        <div id="noti" class="notice hidden"></div>
        <div id="err" class="notice error hidden"></div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">총 작업시간(계획)</div>
            <div class="value" id="kpiForecastHours">-</div>
            <div class="sublabel">기본: <span id="kpiForecastHoursBase">-</span> h</div>
          </div>
          <div class="kpi">
            <div class="label">다음 기간 필요 인원</div>
            <div class="value" id="kpiNextWorkers">-</div>
            <div class="sublabel">기본: <span id="kpiNextWorkersBase">-</span> 명</div>
          </div>
          <div class="kpi">
            <div class="label">목표 시점 필요 인원</div>
            <div class="value" id="kpiTargetWorkers">-</div>
            <div class="sublabel"><span class="badge" id="kpiTargetLabel">-</span> / 기본: <span id="kpiTargetWorkersBase">-</span></div>
          </div>
        </div>

        <div class="kpis">
          <div class="kpi">
            <div class="label">현재 인원</div>
            <div class="value" id="kpiAvailable">-</div>
            <div class="sublabel">S-WORKS SECM 기준</div>
          </div>
          <div class="kpi">
            <div class="label">다음 기간 갭</div>
            <div class="value"><span id="kpiNextGap" class="delta">-</span></div>
            <div class="sublabel">계획 − 현재</div>
          </div>
          <div class="kpi">
            <div class="label">목표 시점 갭</div>
            <div class="value"><span id="kpiTargetGap" class="delta">-</span></div>
            <div class="sublabel">계획 − 현재</div>
          </div>
        </div>

        <div class="card-block" id="conclusionBox">
          <h3 class="block-title">결론 요약</h3>
          <div id="conclusionText" class="narrative"></div>
        </div>
      </div>
    </details>

    <!-- ③ 그래프 -->
    <details class="section" id="sec-graphs">
      <summary>③ 그래프 <span class="summary-badge">작업시간 & 인원</span></summary>
      <div class="section-body">
        <div class="card" style="margin-bottom:8px"><canvas id="chartSeries" height="200"></canvas></div>
        <div class="card"><canvas id="chartWorkers" height="180"></canvas></div>
      </div>
    </details>

    <!-- ④ 예측 표 -->
    <details class="section">
      <summary>④ 예측 표 <span class="summary-badge">일부</span></summary>
      <div class="section-body">
        <div class="card scroll-x">
          <table id="tblForecast" class="table">
            <thead>
              <tr>
                <th>기간</th>
                <th>예측 작업시간(h)</th>
                <th>계획 작업시간(h)</th>
                <th>하한</th>
                <th>상한</th>
                <th>필요 인원(기본)</th>
                <th>필요 인원(계획)</th>
                <th>현재 인원</th>
                <th>갭(계획−현재)</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </details>

    <!-- ⑤ 증원 시점 표 + 월별 해외출장 입력 -->
    <details class="section" open>
      <summary>⑤ 충원 시점 표 <span class="summary-badge">스코프별 채용 필요 시점</span></summary>
      <div class="section-body">
        <div class="toolbar">
          <label class="chip inline card">
            월 수
            <select id="monthsToShow" class="card" style="margin-left:8px">
              <option value="12" selected>12</option>
              <option value="24">24</option>
            </select>
          </label>
          <div class="spacer"></div>
          <button id="btnApplyTrips" class="btn" type="button" disabled>적용</button>
          <button id="btnResetTrips" class="btn ghost" type="button">해외출장 입력 초기화</button>
        </div>

        <div class="table-title">해외 출장 인원</div>
        <div class="card scroll-x sync-scroll" data-sync="hiring" style="margin-bottom:12px">
          <table id="tblTripEdit" class="table table-compact">
            <thead id="tripEditThead"></thead>
            <tbody id="tripEditTbody"></tbody>
          </table>
        </div>

        <div class="table-title">채용 필요 시점</div>
        <div class="card scroll-x sync-scroll" data-sync="hiring">
          <table id="tblHiring" class="table">
            <thead id="tblHiringThead"></thead>
            <tbody id="tblHiringTbody"></tbody>
          </table>
        </div>
      </div>
    </details>
  </div>

  <!-- 로딩 오버레이 -->
  <div id="loading" class="loading hidden"><div class="box">예측 계산 중…</div></div>

  <script src="./js/analysis.js"></script>
      <script defer src="./js/logoutTimer.js"></script>
<script>
document.addEventListener("DOMContentLoaded", function() {
  // ===== 로그인/권한 처리 =====
  const token = localStorage.getItem("x-access-token");
  const userRole = localStorage.getItem("user-role");

  const unsigned = document.querySelector(".unsigned");
  const signed   = document.querySelector(".signed");
  if (!token) {
    unsigned?.classList.remove("hidden");
    signed?.classList.add("hidden");
  } else {
    unsigned?.classList.add("hidden");
    signed?.classList.remove("hidden");
  }
  if (!token || userRole !== 'admin') {
    document.querySelectorAll('.admin-only').forEach(el => { el.style.display = 'none'; });
  }

  const signOutButton = document.querySelector("#sign-out");
  signOutButton?.addEventListener("click", function() {
    localStorage.removeItem("x-access-token");
    localStorage.removeItem("user-role");
    alert("로그아웃 되었습니다.");
    window.location.replace("./signin.html");
  });

  // ===== 햄버거 메뉴 (단일 초기화) =====
  const nav = document.querySelector('nav');
  const btn = nav?.querySelector('.menu-btn');
  const bar = nav?.querySelector('.menu-bar');
  const iconSpans = btn?.querySelectorAll('.menu-icon span') || [];

  if (!btn || !bar) return;

  // 중복 초기화 방지
  if (btn.dataset.hamburgerInit === '1') return;
  btn.dataset.hamburgerInit = '1';

  btn.setAttribute('aria-expanded', 'false');
  bar.setAttribute('aria-hidden', 'true');

  function animateIcon(opened) {
    if (iconSpans.length !== 3) return;
    if (opened) {
      iconSpans[0].style.transform = 'translateY(6px) rotate(45deg)';
      iconSpans[1].style.opacity = '0';
      iconSpans[2].style.transform = 'translateY(-6px) rotate(-45deg)';
    } else {
      iconSpans[0].style.transform = '';
      iconSpans[1].style.opacity = '';
      iconSpans[2].style.transform = '';
    }
  }

  function openMenu() {
    bar.classList.add('open');
    bar.style.maxHeight = bar.scrollHeight + 'px'; // ★ 슬라이드 열림
    btn.setAttribute('aria-expanded', 'true');
    bar.setAttribute('aria-hidden', 'false');
    animateIcon(true);

    document.addEventListener('keydown', escClose);
    document.addEventListener('click', outsideClose);
    window.addEventListener('resize', recalcHeight);
  }

  function closeMenu() {
    // 현재 높이에서 0으로 애니메이트
    bar.style.maxHeight = bar.scrollHeight + 'px';
    void bar.offsetHeight; // reflow
    bar.style.maxHeight = '0px';
    bar.classList.remove('open');
    btn.setAttribute('aria-expanded', 'false');
    bar.setAttribute('aria-hidden', 'true');
    animateIcon(false);

    document.removeEventListener('keydown', escClose);
    document.removeEventListener('click', outsideClose);
    window.removeEventListener('resize', recalcHeight);
  }

  function toggleMenu(e) {
    e?.preventDefault();
    bar.classList.contains('open') ? closeMenu() : openMenu();
  }

  function escClose(e){ if (e.key === 'Escape') closeMenu(); }
  function outsideClose(e){
    if (!nav.contains(e.target)) closeMenu();
  }
  function recalcHeight(){
    if (bar.classList.contains('open')) {
      bar.style.maxHeight = bar.scrollHeight + 'px';
    }
  }

  // 클릭/키보드 토글
  btn.addEventListener('click', toggleMenu);
  btn.addEventListener('keydown', (e)=>{ if(e.key==='Enter'||e.key===' '){ e.preventDefault(); toggleMenu(); } });

  // 메뉴 아이템 클릭 시 자동 닫기
  bar.querySelectorAll('a.menu-item, button.menu-item').forEach(el=>{
    el.addEventListener('click', ()=> closeMenu());
  });
});
</script>
<script>
/** 관리자 접근 가드: 토큰/로컬스토리지 1차 체크 + 서버 재검증 */
async function assertAdmin() {
  const token = localStorage.getItem('x-access-token');
  const role  = localStorage.getItem('user-role');

  // 1차: 로그인/권한 로컬 체크
  if (!token) {
    alert('로그인이 필요합니다.');
    window.location.replace('./signin.html');
    throw new Error('no token'); // 이후 코드 실행 중단
  }
  if (role !== 'admin') {
    alert('접근 권한이 없습니다.');
    window.location.replace('./index.html');
    throw new Error('not admin (local)'); // 이후 코드 실행 중단
  }

  // 2차: 서버에서 역할 재검증(조작/만료 대비)
  try {
    const res = await axios.get('http://3.37.73.151:3001/user-info', {
      headers: { 'x-access-token': token }
    });
    const serverRole = res.data?.result?.ROLE || res.data?.result?.role || res.data?.result?.UserRole;
    if (serverRole && serverRole !== 'admin') {
      alert('접근 권한이 없습니다.');
      window.location.replace('./index.html');
      throw new Error('not admin (server)');
    }
  } catch (err) {
    // 토큰 만료/검증 실패 => 로그인으로
    console.error('admin check failed:', err);
    alert('세션이 만료되었거나 권한 확인에 실패했습니다. 다시 로그인해주세요.');
    window.location.replace('./signin.html');
    throw err;
  }
}

// 다른 탭에서 로그아웃된 경우 즉시 차단
window.addEventListener('storage', (e) => {
  if (e.key === 'x-access-token' && !e.newValue) {
    alert('로그아웃되었습니다.');
    window.location.replace('./signin.html');
  }
});
</script>
</body>
</html>
